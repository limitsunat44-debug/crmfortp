<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Торгового Представителя</title>
    <style>
        /* Perplexity Design System */
        :root {
          /* Primitive Color Tokens */
          --color-white: rgba(255, 255, 255, 1);
          --color-black: rgba(0, 0, 0, 1);
          --color-cream-50: rgba(252, 252, 249, 1);
          --color-cream-100: rgba(255, 255, 253, 1);
          --color-gray-200: rgba(245, 245, 245, 1);
          --color-gray-300: rgba(167, 169, 169, 1);
          --color-gray-400: rgba(119, 124, 124, 1);
          --color-slate-500: rgba(98, 108, 113, 1);
          --color-brown-600: rgba(94, 82, 64, 1);
          --color-charcoal-700: rgba(31, 33, 33, 1);
          --color-charcoal-800: rgba(38, 40, 40, 1);
          --color-slate-900: rgba(19, 52, 59, 1);
          --color-teal-300: rgba(50, 184, 198, 1);
          --color-teal-400: rgba(45, 166, 178, 1);
          --color-teal-500: rgba(33, 128, 141, 1);
          --color-teal-600: rgba(29, 116, 128, 1);
          --color-teal-700: rgba(26, 104, 115, 1);
          --color-teal-800: rgba(41, 150, 161, 1);
          --color-red-400: rgba(255, 84, 89, 1);
          --color-red-500: rgba(192, 21, 47, 1);
          --color-orange-400: rgba(230, 129, 97, 1);
          --color-orange-500: rgba(168, 75, 47, 1);

          /* RGB versions for opacity control */
          --color-brown-600-rgb: 94, 82, 64;
          --color-teal-500-rgb: 33, 128, 141;
          --color-slate-900-rgb: 19, 52, 59;
          --color-slate-500-rgb: 98, 108, 113;
          --color-red-500-rgb: 192, 21, 47;
          --color-red-400-rgb: 255, 84, 89;
          --color-orange-500-rgb: 168, 75, 47;
          --color-orange-400-rgb: 230, 129, 97;

          /* Background color tokens (Light Mode) */
          --color-bg-1: rgba(59, 130, 246, 0.08);
          --color-bg-2: rgba(245, 158, 11, 0.08);
          --color-bg-3: rgba(34, 197, 94, 0.08);
          --color-bg-4: rgba(239, 68, 68, 0.08);
          --color-bg-5: rgba(147, 51, 234, 0.08);
          --color-bg-6: rgba(249, 115, 22, 0.08);
          --color-bg-7: rgba(236, 72, 153, 0.08);
          --color-bg-8: rgba(6, 182, 212, 0.08);

          /* Semantic Color Tokens (Light Mode) */
          --color-background: var(--color-cream-50);
          --color-surface: var(--color-cream-100);
          --color-text: var(--color-slate-900);
          --color-text-secondary: var(--color-slate-500);
          --color-primary: var(--color-teal-500);
          --color-primary-hover: var(--color-teal-600);
          --color-primary-active: var(--color-teal-700);
          --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
          --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
          --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
          --color-border: rgba(var(--color-brown-600-rgb), 0.2);
          --color-btn-primary-text: var(--color-cream-50);
          --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
          --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
          --color-error: var(--color-red-500);
          --color-success: var(--color-teal-500);
          --color-warning: var(--color-orange-500);
          --color-info: var(--color-slate-500);
          --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
          --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

          /* Common style patterns */
          --focus-ring: 0 0 0 3px var(--color-focus-ring);
          --focus-outline: 2px solid var(--color-primary);
          --status-bg-opacity: 0.15;
          --status-border-opacity: 0.25;

          /* RGB versions for opacity control */
          --color-success-rgb: 33, 128, 141;
          --color-error-rgb: 192, 21, 47;
          --color-warning-rgb: 168, 75, 47;
          --color-info-rgb: 98, 108, 113;

          /* Typography */
          --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
          --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
          --font-size-xs: 11px;
          --font-size-sm: 12px;
          --font-size-base: 14px;
          --font-size-md: 14px;
          --font-size-lg: 16px;
          --font-size-xl: 18px;
          --font-size-2xl: 20px;
          --font-size-3xl: 24px;
          --font-size-4xl: 30px;
          --font-weight-normal: 400;
          --font-weight-medium: 500;
          --font-weight-semibold: 550;
          --font-weight-bold: 600;
          --line-height-tight: 1.2;
          --line-height-normal: 1.5;
          --letter-spacing-tight: -0.01em;

          /* Spacing */
          --space-0: 0;
          --space-1: 1px;
          --space-2: 2px;
          --space-4: 4px;
          --space-6: 6px;
          --space-8: 8px;
          --space-10: 10px;
          --space-12: 12px;
          --space-16: 16px;
          --space-20: 20px;
          --space-24: 24px;
          --space-32: 32px;

          /* Border Radius */
          --radius-sm: 6px;
          --radius-base: 8px;
          --radius-md: 10px;
          --radius-lg: 12px;
          --radius-full: 9999px;

          /* Shadows */
          --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
          --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

          /* Animation */
          --duration-fast: 150ms;
          --duration-normal: 250ms;
          --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Dark mode colors */
        @media (prefers-color-scheme: dark) {
          :root {
            --color-gray-400-rgb: 119, 124, 124;
            --color-teal-300-rgb: 50, 184, 198;
            --color-gray-300-rgb: 167, 169, 169;
            --color-gray-200-rgb: 245, 245, 245;

            --color-bg-1: rgba(29, 78, 216, 0.15);
            --color-bg-2: rgba(180, 83, 9, 0.15);
            --color-bg-3: rgba(21, 128, 61, 0.15);
            --color-bg-4: rgba(185, 28, 28, 0.15);
            --color-bg-5: rgba(107, 33, 168, 0.15);
            --color-bg-6: rgba(194, 65, 12, 0.15);
            --color-bg-7: rgba(190, 24, 93, 0.15);
            --color-bg-8: rgba(8, 145, 178, 0.15);

            --color-background: var(--color-charcoal-700);
            --color-surface: var(--color-charcoal-800);
            --color-text: var(--color-gray-200);
            --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
            --color-primary: var(--color-teal-300);
            --color-primary-hover: var(--color-teal-400);
            --color-primary-active: var(--color-teal-800);
            --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
            --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
            --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
            --color-border: rgba(var(--color-gray-400-rgb), 0.3);
            --color-error: var(--color-red-400);
            --color-success: var(--color-teal-300);
            --color-warning: var(--color-orange-400);
            --color-info: var(--color-gray-300);
            --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
            --color-btn-primary-text: var(--color-slate-900);
            --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
            --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

            --color-success-rgb: var(--color-teal-300-rgb);
            --color-error-rgb: var(--color-red-400-rgb);
            --color-warning-rgb: var(--color-orange-400-rgb);
            --color-info-rgb: var(--color-gray-300-rgb);
          }
        }

        /* Base styles */
        html {
          font-size: var(--font-size-base);
          font-family: var(--font-family-base);
          line-height: var(--line-height-normal);
          color: var(--color-text);
          background-color: var(--color-background);
          -webkit-font-smoothing: antialiased;
          box-sizing: border-box;
        }

        body {
          margin: 0;
          padding: 0;
        }

        *, *::before, *::after {
          box-sizing: inherit;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
          margin: 0;
          font-weight: var(--font-weight-semibold);
          line-height: var(--line-height-tight);
          color: var(--color-text);
          letter-spacing: var(--letter-spacing-tight);
        }

        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-md); }

        p {
          margin: 0 0 var(--space-16) 0;
        }

        /* Form elements */
        .form-control {
          display: block;
          width: 100%;
          padding: var(--space-12) var(--space-16);
          font-size: var(--font-size-lg);
          line-height: 1.5;
          color: var(--color-text);
          background-color: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          transition: border-color var(--duration-fast) var(--ease-standard), box-shadow var(--duration-fast) var(--ease-standard);
          min-height: 48px;
        }

        .form-control:focus {
          border-color: var(--color-primary);
          outline: none;
          box-shadow: var(--focus-ring);
        }

        .form-label {
          display: block;
          margin-bottom: var(--space-8);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-base);
          color: var(--color-text);
        }

        .form-group {
          margin-bottom: var(--space-20);
        }

        /* Buttons */
        .btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          padding: var(--space-12) var(--space-20);
          border-radius: var(--radius-base);
          font-size: var(--font-size-lg);
          font-weight: var(--font-weight-medium);
          line-height: 1.5;
          cursor: pointer;
          transition: all var(--duration-normal) var(--ease-standard);
          border: none;
          text-decoration: none;
          position: relative;
          min-height: 48px;
        }

        .btn:focus-visible {
          outline: none;
          box-shadow: var(--focus-ring);
        }

        .btn--primary {
          background: var(--color-primary);
          color: var(--color-btn-primary-text);
        }

        .btn--primary:hover {
          background: var(--color-primary-hover);
        }

        .btn--secondary {
          background: var(--color-secondary);
          color: var(--color-text);
        }

        .btn--secondary:hover {
          background: var(--color-secondary-hover);
        }

        .btn--danger {
          background: var(--color-error);
          color: var(--color-white);
        }

        .btn--danger:hover {
          background: rgba(var(--color-error-rgb), 0.8);
        }

        .btn--success {
          background: var(--color-success);
          color: var(--color-white);
        }

        .btn--full-width {
          width: 100%;
        }

        .btn--sm {
          padding: var(--space-8) var(--space-12);
          font-size: var(--font-size-sm);
          min-height: 36px;
        }

        /* Card component */
        .card {
          background-color: var(--color-surface);
          border-radius: var(--radius-lg);
          border: 1px solid var(--color-card-border);
          box-shadow: var(--shadow-sm);
          overflow: hidden;
          margin-bottom: var(--space-16);
        }

        .card__body {
          padding: var(--space-20);
        }

        .card__header {
          padding: var(--space-20);
          border-bottom: 1px solid var(--color-card-border-inner);
          background: var(--color-bg-1);
        }

        /* Status indicators */
        .status {
          display: inline-flex;
          align-items: center;
          padding: var(--space-6) var(--space-12);
          border-radius: var(--radius-full);
          font-weight: var(--font-weight-medium);
          font-size: var(--font-size-sm);
        }

        .status--success {
          background-color: rgba(var(--color-success-rgb), 0.15);
          color: var(--color-success);
          border: 1px solid rgba(var(--color-success-rgb), 0.25);
        }

        .status--error {
          background-color: rgba(var(--color-error-rgb), 0.15);
          color: var(--color-error);
          border: 1px solid rgba(var(--color-error-rgb), 0.25);
        }

        /* Layout */
        .container {
          width: 100%;
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 var(--space-16);
        }

        .mobile-container {
          width: 100%;
          max-width: 500px;
          margin: 0 auto;
          padding: var(--space-16);
        }

        /* Utility classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .gap-8 { gap: var(--space-8); }
        .gap-16 { gap: var(--space-16); }
        .mb-16 { margin-bottom: var(--space-16); }
        .mb-20 { margin-bottom: var(--space-20); }
        .mt-8 { margin-top: var(--space-8); }
        .text-center { text-align: center; }
        .text-sm { font-size: var(--font-size-sm); }
        .text-error { color: var(--color-error); }

        /* App specific styles */
        .app-header {
          background: var(--color-primary);
          color: var(--color-white);
          padding: var(--space-16) 0;
          margin-bottom: var(--space-24);
        }

        .app-nav {
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-wrap: wrap;
          gap: var(--space-8);
        }

        .nav-tabs {
          display: flex;
          gap: var(--space-8);
          flex-wrap: wrap;
        }

        .nav-tab {
          padding: var(--space-8) var(--space-16);
          background: rgba(255, 255, 255, 0.1);
          color: var(--color-white);
          border: none;
          border-radius: var(--radius-base);
          cursor: pointer;
          font-size: var(--font-size-sm);
          min-height: 36px;
        }

        .nav-tab.active {
          background: var(--color-white);
          color: var(--color-primary);
        }

        .visit-item {
          padding: var(--space-16);
          border-bottom: 1px solid var(--color-card-border-inner);
        }

        .visit-item:last-child {
          border-bottom: none;
        }

        .visit-meta {
          display: flex;
          justify-content: space-between;
          align-items: flex-start;
          margin-bottom: var(--space-8);
          flex-wrap: wrap;
          gap: var(--space-8);
        }

        .visit-doctor {
          font-weight: var(--font-weight-semibold);
          font-size: var(--font-size-lg);
        }

        .visit-details {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: var(--space-8);
          margin: var(--space-8) 0;
        }

        .visit-detail {
          font-size: var(--font-size-sm);
          color: var(--color-text-secondary);
        }

        .visit-detail strong {
          color: var(--color-text);
          display: block;
          margin-bottom: var(--space-2);
        }

        .search-input {
          position: relative;
        }

        .doctor-search {
          width: 100%;
        }

        .doctor-dropdown {
          position: absolute;
          top: 100%;
          left: 0;
          right: 0;
          background: var(--color-surface);
          border: 1px solid var(--color-border);
          border-radius: var(--radius-base);
          box-shadow: var(--shadow-md);
          max-height: 200px;
          overflow-y: auto;
          z-index: 10;
        }

        .doctor-option {
          padding: var(--space-12) var(--space-16);
          cursor: pointer;
          border-bottom: 1px solid var(--color-card-border-inner);
        }

        .doctor-option:last-child {
          border-bottom: none;
        }

        .doctor-option:hover {
          background: var(--color-bg-1);
        }

        .doctor-code {
          color: var(--color-text-secondary);
          font-size: var(--font-size-sm);
          margin-left: var(--space-8);
        }

        .action-buttons {
          display: flex;
          gap: var(--space-8);
          flex-wrap: wrap;
          margin-top: var(--space-8);
        }

        .login-form {
          max-width: 400px;
          margin: 10vh auto;
          padding: var(--space-32);
        }

        .radio-group {
          display: flex;
          gap: var(--space-16);
          margin: var(--space-8) 0;
        }

        .radio-option {
          display: flex;
          align-items: center;
          gap: var(--space-8);
          cursor: pointer;
        }

        .radio-option input {
          margin: 0;
        }

        .filter-section {
          background: var(--color-bg-2);
          padding: var(--space-16);
          border-radius: var(--radius-base);
          margin-bottom: var(--space-16);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
          .mobile-container {
            padding: var(--space-12);
          }

          .app-nav {
            flex-direction: column;
            align-items: flex-start;
          }

          .nav-tabs {
            width: 100%;
            justify-content: flex-start;
            overflow-x: auto;
            padding-bottom: var(--space-4);
          }

          .visit-details {
            grid-template-columns: 1fr;
          }

          .visit-meta {
            flex-direction: column;
            align-items: flex-start;
          }

          .action-buttons {
            width: 100%;
          }

          .action-buttons .btn {
            flex: 1;
            min-width: 0;
          }
        }

        @font-face {
          font-family: 'FKGroteskNeue';
          src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
        }
    </style>
</head>
<body>
    <!-- Экран входа -->
    <div id="loginScreen" class="">
        <div class="login-form">
            <div class="card">
                <div class="card__header">
                    <h2 class="text-center">Вход в систему</h2>
                </div>
                <div class="card__body">
                    <form id="loginForm">
                        <div class="form-group">
                            <label class="form-label">Логин:</label>
                            <input type="text" id="username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Пароль:</label>
                            <input type="password" id="password" class="form-control" required>
                        </div>
                        <div id="loginError" class="text-error text-sm hidden mb-16"></div>
                        <button type="submit" class="btn btn--primary btn--full-width">Войти</button>
                    </form>
                    <div class="mt-8 text-sm text-center" style="color: var(--color-text-secondary);">
                        <p>Тестовые пользователи:</p>
                        <p>admin1 / admin123 (Админ)</p>
                        <p>admin2 / admin123 (Админ)</p>
                        <p>sales1 / sales123 (Торговый представитель)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основное приложение -->
    <div id="appScreen" class="hidden">
        <!-- Заголовок приложения -->
        <header class="app-header">
            <div class="container">
                <div class="app-nav">
                    <h1>CRM Торгового Представителя</h1>
                    <div class="nav-tabs">
                        <button class="nav-tab active" data-tab="visits">Визиты</button>
                        <button class="nav-tab" data-tab="add-visit">Новый визит</button>
                        <button class="nav-tab admin-only hidden" data-tab="add-doctor">Добавить врача</button>
                        <button class="nav-tab" data-tab="profile" id="profileTab">Профиль</button>
                    </div>
                    <button class="btn btn--secondary btn--sm" id="logoutBtn">Выйти</button>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- Вкладка "Визиты" -->
            <div id="visitsTab" class="tab-content">
                <div class="flex justify-between items-center mb-16" style="flex-wrap: wrap; gap: var(--space-16);">
                    <h2 style="margin: 0;">Список визитов</h2>
                    <button class="btn btn--primary" id="addVisitBtn">Добавить визит</button>
                </div>
                
                <!-- Фильтры -->
                <div class="filter-section">
                    <div class="flex gap-16" style="flex-wrap: wrap; align-items: flex-end;">
                        <div class="form-group" style="margin-bottom: 0; min-width: 200px;">
                            <label class="form-label">Фильтр по дате:</label>
                            <input type="date" id="dateFilter" class="form-control">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <button class="btn btn--secondary btn--sm" id="clearFilter">Сбросить</button>
                        </div>
                        <div class="form-group admin-only hidden" style="margin-bottom: 0; min-width: 200px;">
                            <label class="form-label">Пользователь:</label>
                            <select id="userFilter" class="form-control">
                                <option value="">Все пользователи</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="visitsList">
                    <!-- Список визитов будет сгенерирован JS -->
                </div>
            </div>

            <!-- Вкладка "Новый визит" -->
            <div id="addVisitTab" class="tab-content hidden">
                <h2 class="mb-16">Добавить новый визит</h2>
                <div class="card">
                    <div class="card__body">
                        <form id="visitForm">
                            <div class="form-group">
                                <label class="form-label">Врач:</label>
                                <div class="search-input">
                                    <input type="text" id="doctorSearch" class="form-control doctor-search" placeholder="Начните вводить имя врача..." autocomplete="off" required>
                                    <div id="doctorDropdown" class="doctor-dropdown hidden"></div>
                                </div>
                                <input type="hidden" id="selectedDoctorId" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Дата и время визита:</label>
                                <input type="datetime-local" id="visitDateTime" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Клиника:</label>
                                <input type="text" id="clinic" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Сумма в сомони:</label>
                                <input type="number" id="amount" class="form-control" step="0.01" min="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Статус врача:</label>
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input type="radio" name="status" value="satisfied" required>
                                        <span>✅ Доволен</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="status" value="unsatisfied" required>
                                        <span>❌ Не доволен</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Дата следующего визита:</label>
                                <input type="date" id="nextVisitDate" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Комментарий:</label>
                                <textarea id="comment" class="form-control" rows="3" placeholder="Дополнительные заметки..."></textarea>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn--primary btn--full-width" id="saveVisitBtn">Сохранить визит</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Добавить врача" (только для админов) -->
            <div id="addDoctorTab" class="tab-content hidden">
                <h2 class="mb-16">Добавить нового врача</h2>
                <div class="card">
                    <div class="card__body">
                        <form id="doctorForm">
                            <div class="form-group">
                                <label class="form-label">Имя врача:</label>
                                <input type="text" id="doctorName" class="form-control" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Код врача:</label>
                                <input type="text" id="doctorCode" class="form-control" required>
                            </div>
                            
                            <div class="action-buttons">
                                <button type="submit" class="btn btn--primary btn--full-width">Добавить врача</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Вкладка "Профиль" -->
            <div id="profileTab" class="tab-content hidden">
                <h2 class="mb-16">Профиль пользователя</h2>
                <div class="card">
                    <div class="card__body">
                        <div id="userInfo">
                            <!-- Информация о пользователе будет сгенерирована JS -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальное окно добавления визита -->
    <div id="addVisitModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: var(--space-16);">
        <div class="card" style="width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="card__header">
                <div class="flex justify-between items-center">
                    <h3>Добавить новый визит</h3>
                    <button type="button" class="btn btn--secondary btn--sm" id="closeAddModal" style="padding: var(--space-4) var(--space-8);">&times;</button>
                </div>
            </div>
            <div class="card__body">
                <form id="addVisitModalForm">
                    <div class="form-group">
                        <label class="form-label">Врач:</label>
                        <div class="search-input">
                            <input type="text" id="modalDoctorSearch" class="form-control doctor-search" placeholder="Начните вводить имя врача..." autocomplete="off" required>
                            <div id="modalDoctorDropdown" class="doctor-dropdown hidden"></div>
                        </div>
                        <input type="hidden" id="modalSelectedDoctorId" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Дата и время визита:</label>
                        <input type="datetime-local" id="modalVisitDateTime" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Клиника:</label>
                        <input type="text" id="modalClinic" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сумма в сомони:</label>
                        <input type="number" id="modalAmount" class="form-control" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Статус врача:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="modalStatus" value="satisfied" required>
                                <span>✅ Доволен</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="modalStatus" value="unsatisfied" required>
                                <span>❌ Не доволен</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Дата следующего визита:</label>
                        <input type="date" id="modalNextVisitDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Комментарий:</label>
                        <textarea id="modalComment" class="form-control" rows="3" placeholder="Дополнительные заметки..."></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="submit" class="btn btn--primary">Сохранить визит</button>
                        <button type="button" class="btn btn--secondary" id="cancelAddModal">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно редактирования визита -->
    <div id="editModal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: var(--space-16);">
        <div class="card" style="width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;">
            <div class="card__header">
                <h3>Редактировать визит</h3>
            </div>
            <div class="card__body">
                <form id="editVisitForm">
                    <div class="form-group">
                        <label class="form-label">Врач:</label>
                        <div class="search-input">
                            <input type="text" id="editDoctorSearch" class="form-control doctor-search" autocomplete="off" required>
                            <div id="editDoctorDropdown" class="doctor-dropdown hidden"></div>
                        </div>
                        <input type="hidden" id="editSelectedDoctorId" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Дата и время визита:</label>
                        <input type="datetime-local" id="editVisitDateTime" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Клиника:</label>
                        <input type="text" id="editClinic" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Сумма в сомони:</label>
                        <input type="number" id="editAmount" class="form-control" step="0.01" min="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Статус врача:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="editStatus" value="satisfied">
                                <span>✅ Доволен</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="editStatus" value="unsatisfied">
                                <span>❌ Не доволен</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Дата следующего визита:</label>
                        <input type="date" id="editNextVisitDate" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Комментарий:</label>
                        <textarea id="editComment" class="form-control" rows="3"></textarea>
                    </div>
                    
                    <div class="action-buttons">
                        <button type="submit" class="btn btn--primary">Сохранить изменения</button>
                        <button type="button" class="btn btn--secondary" id="cancelEdit">Отмена</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
const BIN_ID = "68ef4a80d0ea881f40a3d52f";
const API_KEY = "$2a$10$o0Vb2fBmb4Fs6.iOzhUgW.eGxkQqP.bXH7x2fjrlyLf.xFY68lXpG";
const BASE_URL = "https://api.jsonbin.io/v3/b/";
      
// Загрузка визитов при входе
async function loadVisits() {
  const res = await fetch(`${BASE_URL}${BIN_ID}/latest`, {
    headers: { "X-Master-Key": API_KEY }
  });
  const data = await res.json();
  localStorage.setItem("visits", JSON.stringify(data.record.visits || []));
  renderVisits();
}

// Сохранение визитов (при добавлении нового)
async function saveVisits(visits) {
  localStorage.setItem("visits", JSON.stringify(visits));
  await fetch(`${BASE_URL}${BIN_ID}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify({ visits })
  });
}


        // Данные приложения (в памяти, вместо localStorage)
        let appData = {
            currentUser: null,
            users: [
                { id: 'admin1', username: 'admin1', password: 'admin123', role: 'admin', name: 'Администратор 1' },
                { id: 'admin2', username: 'admin2', password: 'admin123', role: 'admin', name: 'Администратор 2' },
                { id: 'sales1', username: 'sales1', password: 'sales123', role: 'sales', name: 'Торговый представитель' }
            ],
            doctors: [
                {code: '100', name: 'Назаров Исомуддин'}, {code: '102', name: 'Рахматов Холмаджон'}, {code: '103', name: 'Толибов Диловар'},
                {code: '104', name: 'Рахмонова Бунафша'}, {code: '105', name: 'Абдуллаева Шабнам'}, {code: '106', name: 'Абдуллоев Мурод'},
                {code: '107', name: 'Бобоев Мухаммадрахим'}, {code: '108', name: 'Абдулхаева Шамсия'}, {code: '109', name: 'Азамов Акбар'},
                {code: '110', name: 'Диловар Хокироев'}, {code: '111', name: 'Нурхонов Дилшод'}, {code: '112', name: 'Нуриддинзода Насима'},
                {code: '113', name: 'Шарипова Фарзона'}, {code: '115', name: 'Хакназар Хакназарович'}, {code: '116', name: 'Алиджон Джураевич'},
                {code: '117', name: 'Наджмиддинов Неъматджон'}, {code: '118', name: 'Ярбобоев Сайфулло'}, {code: '119', name: 'Сафарова Анахита'},
                {code: '120', name: 'Ахмедов Сахиджон'}, {code: '121', name: 'Ашуров Бахтиер'}, {code: '122', name: 'Ганиев Боймурод'},
                {code: '123', name: 'Гулноза Сайфова'}, {code: '124', name: 'Солиев Шухрат'}, {code: '125', name: 'Зарина Алимова'},
                {code: '126', name: 'Зокиров Аминджон'}, {code: '127', name: 'Хайдарова Фотима'}, {code: '128', name: 'Исаева Холида'},
                {code: '129', name: 'Низомова Мавджуда'}, {code: '130', name: 'Холилова Зульфия'}, {code: '131', name: 'Абдуллоев Юсуф'},
                {code: '132', name: 'Кадиров Саидшариф'}, {code: '133', name: 'Солимзода Муким'}, {code: '134', name: 'Хасанов Бехруз'},
                {code: '135', name: 'Тешаев Фируз'}, {code: '136', name: 'Умедов Ахлиддин'}, {code: '137', name: 'Зарина Тагоева'},
                {code: '138', name: 'Джураев Хуршед'}, {code: '139', name: 'Янгибаева Барно'}, {code: '140', name: 'Мадаминова Истода'},
                {code: '141', name: 'Пирназаров Нурали'}, {code: '142', name: 'Салимов Мухиддин'}, {code: '143', name: 'Рафиев Ахмад'},
                {code: '144', name: 'Ахмедов Азиз'}, {code: '145', name: 'Хадамова Бахтигул'}, {code: '146', name: 'Соназаров Абдуманон'},
                {code: '147', name: 'Умаров Баходур'}, {code: '148', name: 'Махмадалиев Гуломхайлар'}, {code: '149', name: 'Мастибекова Гулджахон'},
                {code: '150', name: 'Джойлонов Диловар'}, {code: '151', name: 'Ситора Нуралиева'}, {code: '152', name: 'Рахимназарова Дарина'},
                {code: '153', name: 'Ниезов Мухаммадзодин'}, {code: '154', name: 'Исупов Шамсуддин'}, {code: '155', name: 'Расулов Лочин'},
                {code: '156', name: 'Асозода Мунис'}, {code: '157', name: 'Шеров Мубориз'}, {code: '158', name: 'Раджабов Парвиз'},
                {code: '160', name: 'Холова Зебо'}, {code: '161', name: 'Косимова Фируза'}, {code: '162', name: 'Мамадбекова Кодиламох'},
                {code: '163', name: 'Нилюфари Хакназар'}, {code: '164', name: 'Мухаммадали Хотамиен'}, {code: '165', name: 'Шохиди Дилбар'},
                {code: '167', name: 'Косимова Манижа'}, {code: '168', name: 'Шарапова Азиза'}, {code: '170', name: 'Тришина Анна'},
                {code: '171', name: 'Усмонов Хайрулло'}, {code: '172', name: 'Завицкая Татьяна'}, {code: '173', name: 'Сафарова Шахло'},
                {code: '174', name: 'Исокова Зульфида'}, {code: '175', name: 'Мавджуда Рахимова'}, {code: '176', name: 'Турсунова Хадиса'},
                {code: '177', name: 'Хайдарова Умеда'}, {code: '178', name: 'Наташа Массаж'}, {code: '179', name: 'Хазанбаевич Сидик'},
                {code: '180', name: 'Гоибназаров Анвар'}, {code: '181', name: 'Зоиров Сирохиддин'}, {code: '182', name: 'Олимова Клавдия'},
                {code: '183', name: 'Камилова Нигора'}, {code: '184', name: 'Донаева Нигина'}, {code: '185', name: 'Барно Массаж на дому'},
                {code: '186', name: 'Фаризаи Шерализод массаж'}, {code: '187', name: 'Джабарова Нигора массаж'}, {code: '189', name: 'Диляфруз массаж на дому'},
                {code: '190', name: 'Чориев Шухрат'}, {code: '192', name: 'Абдуллоев Мухтоджон'}, {code: '193', name: 'Марина Рашидовна'},
                {code: '194', name: 'Маршарапова Барно'}, {code: '195', name: 'Назарова Сурайо Д/с Аниса'}, {code: '196', name: 'Сатторов Абдужалил'},
                {code: '197', name: 'Султонов Шахобиддин'}, {code: '198', name: 'Хушватов Саиджон'}, {code: '199', name: 'Ярматов Лутфулло'}
                // Добавлены только первые 100 врачей для краткости, в реальном приложении будут все
            ],
            visits: [],
            nextVisitId: 1
        };

        // Добавляем остальных врачей из полного списка
        const additionalDoctors = [
            {code: '200', name: 'Ятимов Парвиз'}, {code: '201', name: 'Разоков Абдували'}, {code: '202', name: 'Хайдаров Аминджон'},
            {code: '203', name: 'Курбонализода Ином'}, {code: '204', name: 'Сатторов Шамсиддин'}, {code: '205', name: 'Иброхимов Фариддун'},
            {code: '206', name: 'Риеев Исмоил'}, {code: '207', name: 'Абдурахмонов Шахбоз'}, {code: '208', name: 'Насруллоев Нурулло'},
            {code: '209', name: 'Мамадиев Зульфикор'}, {code: '210', name: 'Гульшоев Кудратулло'}, {code: '211', name: 'Чориев Ахтам'},
            {code: '212', name: 'Назаров Холтура'}, {code: '213', name: 'Хусайнов Анвар'}, {code: '214', name: 'Хусейнзода Назрулло'},
            {code: '215', name: 'Назирбаева Оксана'}, {code: '216', name: 'Курбонов Чилахон'}, {code: '217', name: 'Халимов Манучехр'},
            {code: '218', name: 'Махамадали Кадырович'}, {code: '219', name: 'Мавлуда Шерматовна'}, {code: '220', name: 'Сафаров Одил'},
            {code: '221', name: 'Сафарзода Имрон'}, {code: '222', name: 'Турсуновна Шарофат'}, {code: '223', name: 'Кузиева Чулпаной'},
            {code: '224', name: 'Имамова Бунафша'}, {code: '225', name: 'Матлубов Тохир'}, {code: '226', name: 'Мирасанова Гулнисо'},
            {code: '227', name: 'Чориев Абдусаттор'}, {code: '228', name: 'Давлатова Шамсия'}, {code: '229', name: 'Шоев Шахбоз'},
            {code: '230', name: 'Салимова Шахзода'}, {code: '231', name: 'Абдуллоева Замира'}, {code: '232', name: 'Азизов Давлатхоча'},
            {code: '233', name: 'Шеров Махмадсаид'}, {code: '234', name: 'Узоков Ином'}, {code: '235', name: 'Ходжаев Рахматулло'},
            {code: '236', name: 'Хасанзода Хабибшо'}, {code: '237', name: 'Примов Бехруз'}, {code: '238', name: 'Ашуров Исмоил'},
            {code: '239', name: 'Наимов Бунед'}, {code: '240', name: 'Кодиров Додулло'}, {code: '241', name: 'Кобилов Набичон'},
            {code: '242', name: 'Барно Хамидчоновна'}, {code: '500', name: 'Шарипов Мирзо'}, {code: '501', name: 'Курбанов Саидбилол'},
            {code: '502', name: 'Сагизов Насим'}, {code: '503', name: 'Шерматов Бахтиер'}, {code: '504', name: 'Бегматов Хакназар'},
            {code: '505', name: 'Толибов Шоди'}, {code: '506', name: 'Тоджибоев Ином'}, {code: '507', name: 'Сабуров Муродали'},
            {code: '508', name: 'Пиров Рискулло'}, {code: '509', name: 'Сохиба Мирзоевна'}, {code: '510', name: 'Курбонова Райфа'},
            {code: '511', name: 'Юнусов Исломиддин'}, {code: '512', name: 'Кахоров Зухириддин'}, {code: '513', name: 'Кадамов Саидмумин'},
            {code: '514', name: 'Аптека 1'}, {code: '515', name: 'Рано 11корп.'}, {code: '516', name: 'Самиев Бахтиер'},
            {code: '517', name: 'Эхсонов Абдушукур'}, {code: '518', name: 'Косимова Махмудахон'}, {code: '519', name: 'Демченко Людмила'},
            {code: '520', name: 'Ёрматов Файзали'}, {code: '521', name: 'Мирзобекова Гулнора'}, {code: '522', name: 'Ортикова Мунира'},
            {code: '523', name: 'Ахмедова Гульназ'}, {code: '524', name: 'Розия Пулатовна'}, {code: '525', name: 'Мукаддас Файзулаевна'},
            {code: '526', name: 'Мукаррама Асланова'}, {code: '527', name: 'Кулмамадова Алфия'}, {code: '528', name: 'Асоев Усмон'},
            {code: '529', name: 'Норбеков Шухрат'}, {code: '530', name: 'Ахмедова Диловара'}, {code: '531', name: 'Басирова Фируза'},
            {code: '532', name: 'Сафаров Диловар'}, {code: '533', name: 'Чоршанбиев Пулод'}, {code: '534', name: 'Джамиля Назарова'},
            {code: '535', name: 'Шамиев Бахтиер'}, {code: '536', name: 'Курбонова Лутфия'}, {code: '537', name: 'Гульчехра Фатхуллоева'},
            {code: '539', name: 'Рахимова Сайрам'}, {code: '540', name: 'Рикардо Мюллер'}, {code: '541', name: 'Тошпулотов Хуршед'},
            {code: '542', name: 'Рейс Татьяна'}, {code: '543', name: 'Хайдаров Шамсиддин'}, {code: '544', name: 'Раджабова Диляфруз'},
            {code: '545', name: 'Камолов Мухаммад'}, {code: '546', name: 'Боймуродов Бобомурод'}, {code: '547', name: 'Саидмуродов Хилоли'},
            {code: '548', name: 'Ганиев Хусейн'}, {code: '549', name: 'Разоков Жанобиддин'}, {code: '550', name: 'Зайнудиннов Давлатмурод'},
            {code: '551', name: 'Каюмов Муроджон'}, {code: '552', name: 'Дустов Хусейн'}, {code: '554', name: 'Мирзобеков Курбонали'},
            {code: '555', name: 'Холов Анвар'}, {code: '556', name: 'Ниязова Мухае'}, {code: '557', name: 'Амонова Саломат'},
            {code: '558', name: 'Лола Джумаева'}, {code: '559', name: 'Фарид Курбонов'}, {code: '561', name: 'Салимзода Ортопед 4.к.'},
            {code: '562', name: 'Асроров Мухаммадсаттор'}, {code: '563', name: 'Рахимов Абубакр'}, {code: '564', name: 'Шахбоз ортопед 13поликл.'},
            {code: '565', name: 'Мираков Бехруз'}, {code: '567', name: 'Джалилов Шерзод'}, {code: '568', name: 'Тоиров Исмоил'},
            {code: '569', name: 'Интернет'}, {code: '571', name: 'Хасанова Хуршеда'}, {code: '572', name: 'Набиев Мухабатулло'},
            {code: '573', name: 'Шукруллоев Андалеб'}, {code: '574', name: 'Бобохонов Субхон'}, {code: '575', name: 'Джаборов Манучехр'},
            {code: '576', name: 'Абдуллаев М. 2к.'}, {code: '577', name: 'Холмуминов Даврон'}, {code: '578', name: 'Юнусов Муродбек'},
            {code: '580', name: 'Джалолов Зулфич'}, {code: '582', name: 'Рано Хабибулаевна Роддом'}, {code: '583', name: 'Тошева Диляфруз'},
            {code: '584', name: 'Беков Абдугани'}, {code: '585', name: 'Мирзохонов Умархон'}, {code: '586', name: 'Иззатзода Нурулло'},
            {code: '587', name: 'Мамаджанова Гулнора'}, {code: '588', name: 'Иброхимов Иброхим'}, {code: '589', name: 'Хамзаев Хазрат'},
            {code: '590', name: 'Сафияи Амирхон'}, {code: '592', name: 'Раджабова Шоира'}, {code: '654', name: 'Ниезов Мадади Акбар ортопед'},
            {code: '655', name: 'Сироджзода Кутбиддин'}, {code: '656', name: 'Ходжаев Фирдавс'}, {code: '658', name: 'Хабибулаева Фарзона'},
            {code: '659', name: 'Нурахмадов Фаррух'}, {code: '660', name: 'Холова Садбарг'}, {code: '662', name: 'Ходжаев Хоким'},
            {code: '666', name: 'Нуралиева 11 кор караб'}, {code: '667', name: 'Тагоев Дилшод'}, {code: '668', name: 'Сатторов Истиклол'},
            {code: '669', name: 'Насиба Махмадова'}, {code: '670', name: 'Давлатов Хабибулло'}, {code: '671', name: 'Шарифзода Шараф'},
            {code: '672', name: 'Ризвонов Асрор караб'}, {code: '674', name: 'Халилова Рано'}, {code: '675', name: 'Абдуллаев Исматулло'},
            {code: '676', name: 'Каримов 4 кор караб'}, {code: '677', name: 'Озода массаж аэропорт'}, {code: '678', name: 'Курбонов Екубчон'},
            {code: '680', name: 'Гаюров Курган-Тюбе'}, {code: '681', name: 'Охунова Хабиба'}, {code: '683', name: 'Даврон Мусоев'},
            {code: '684', name: 'Садиров Ворис'}, {code: '685', name: 'Тагоев Амрулло'}, {code: '688', name: 'Ибрагимова Мехрона пол№2'},
            {code: '689', name: 'Алиев Навруз'}, {code: '690', name: 'Буйраев Султонмурод'}, {code: '691', name: 'Зайнуддинов Бегичон'},
            {code: '692', name: 'Нуриддинов Мансур'}, {code: '693', name: 'Тоджибоев Абдурассул'}, {code: '694', name: 'Эсанов Сафармат'},
            {code: '695', name: 'Рахимзода Фируз'}, {code: '696', name: 'Джураева Нафиса'}, {code: '697', name: 'Сафаров Маруф'},
            {code: '698', name: 'Шарипов Юнус'}, {code: '699', name: 'Гафуров Шохон'}, {code: '700', name: 'Аминов Мухаммад'},
            {code: '701', name: 'Айниев Борон'}, {code: '702', name: 'Саидов Чахонгир'}, {code: '703', name: 'Зухро Курган'},
            {code: '704', name: 'Кариева Мадина'}, {code: '705', name: 'Жигулина Марина'}, {code: '706', name: 'Мамадшоева Рахима'},
            {code: '707', name: 'Яхшиева Юлдуз'}, {code: '708', name: 'Мусоева Насиба'}, {code: '709', name: 'Елезавета Олеговна'},
            {code: '710', name: 'Додомирзоева Гулчечак'}, {code: '711', name: 'Абдуллоев Алишер'}, {code: '712', name: 'Рахмонов Бахтиер'},
            {code: '713', name: 'Каримова Назира'}, {code: '714', name: 'Игамова Малика'}, {code: '715', name: 'Назриддинова Нигора'},
            {code: '716', name: 'Чамиля Дилмуродовна'}, {code: '717', name: 'Мухитдинов Хуросон'}, {code: '718', name: 'Махфират Хошимовна'},
            {code: '719', name: 'Хасаншоева Диагностика'}, {code: '720', name: 'Орипов Мухаммад'}, {code: '721', name: 'Абдуллаева Нодира'},
            {code: '722', name: 'Файзуллаева Поликлника 8'}, {code: '723', name: 'Назаров Хотура Пахтобод'}, {code: '724', name: 'Мирхасанова Гульнисо Ленинский'},
            {code: '725', name: 'Ерова Зебо Мехргон'}, {code: '726', name: 'Назаров Рустам'}, {code: '727', name: 'Олимова Поликлиника 14'},
            {code: '728', name: 'Идиев 1 советский'}, {code: '729', name: 'Хотамов Мирзо Пахтобод'}, {code: '730', name: 'Давлатова Ноэля'},
            {code: '731', name: 'Алишер Массажист Диамед'}, {code: '732', name: 'Самадова Умеда'}, {code: '733', name: 'Аскарова Фируза'},
            {code: '734', name: 'АбдулХамидов Алишер'}, {code: '735', name: 'Мусоев Бобошо'}, {code: '736', name: 'Иброхимова Дилафруз'},
            {code: '737', name: 'Саидов Мирали'}, {code: '738', name: 'Умеда Стопа Спина'}, {code: '739', name: 'Давлатов Талабшо Хисор'},
            {code: '740', name: 'Аскаров Алишер'}, {code: '741', name: 'Бобоев Голиб'}, {code: '742', name: 'Хайруллоева Дилбар'},
            {code: '743', name: 'Маматова Гулола'}, {code: '744', name: 'Сафарзода Хуршед'}, {code: '745', name: 'Камолов Икромиддин'},
            {code: '746', name: 'Абдуллоев Аюбшо'}, {code: '747', name: 'Муродов Сорбон'}, {code: '748', name: 'Хабибуллоева Мехрангез'},
            {code: '749', name: 'Довудов Алимурод'}, {code: '751', name: 'Умаров Сайфулло'}, {code: '752', name: 'Фируза Пулатовна'},
            {code: '753', name: 'Холматова Гульджахон'}, {code: '754', name: 'Курбонов Муртазо'}, {code: '755', name: 'Сокиев Ислом'},
            {code: '756', name: 'Махмадиев Зулфикор'}, {code: '757', name: 'Файзуллоев Файзулло'}, {code: '758', name: 'Абдурахманов Саидумар'},
            {code: '759', name: 'Садуллоев Рустам'}, {code: '760', name: 'Шарифова Адиба'}, {code: '761', name: 'Боев Бахтиер'}
        ];
        
        appData.doctors = appData.doctors.concat(additionalDoctors);

        // Функции для работы с данными
        function getCurrentUser() {
            return appData.currentUser;
        }

        function setCurrentUser(user) {
            appData.currentUser = user;
        }

        function getDoctors() {
            return appData.doctors;
        }

        function addDoctor(doctor) {
            appData.doctors.push(doctor);
        }

        function getVisits() {
            return appData.visits;
        }

        function addVisit(visit) {
            visit.id = appData.nextVisitId++;
            visit.createdAt = new Date().toISOString();
            appData.visits.push(visit);
        }

        function updateVisit(visitId, updatedVisit) {
            const index = appData.visits.findIndex(v => v.id === visitId);
            if (index !== -1) {
                appData.visits[index] = { ...appData.visits[index], ...updatedVisit };
            }
        }

        function deleteVisit(visitId) {
            appData.visits = appData.visits.filter(v => v.id !== visitId);
        }

        // DOM элементы
        const loginScreen = document.getElementById('loginScreen');
        const appScreen = document.getElementById('appScreen');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutBtn = document.getElementById('logoutBtn');
        
        // Вкладки
        const navTabs = document.querySelectorAll('.nav-tab');
        const tabContents = document.querySelectorAll('.tab-content');

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            // Проверяем авторизацию
            showLoginScreen();
            
            // Обработчики событий
            setupEventListeners();
            
            // Инициализация UI
            setupUI();
        }

        function setupEventListeners() {
            // Авторизация
            loginForm.addEventListener('submit', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            
            // Навигация по вкладкам
            navTabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // Формы
            document.getElementById('visitForm').addEventListener('submit', handleAddVisit);
            document.getElementById('addVisitModalForm').addEventListener('submit', handleAddVisitFromModal);
            document.getElementById('doctorForm').addEventListener('submit', handleAddDoctor);
            document.getElementById('editVisitForm').addEventListener('submit', handleEditVisit);
            
            // Поиск врачей
            setupDoctorSearch('doctorSearch', 'doctorDropdown', 'selectedDoctorId');
            setupDoctorSearch('modalDoctorSearch', 'modalDoctorDropdown', 'modalSelectedDoctorId');
            setupDoctorSearch('editDoctorSearch', 'editDoctorDropdown', 'editSelectedDoctorId');
            
            // Фильтры
            document.getElementById('dateFilter').addEventListener('change', filterVisits);
            document.getElementById('userFilter').addEventListener('change', filterVisits);
            document.getElementById('clearFilter').addEventListener('click', clearFilters);
            
            // Модальное окно добавления визита
            document.getElementById('addVisitBtn').addEventListener('click', openAddVisitModal);
            document.getElementById('closeAddModal').addEventListener('click', closeAddVisitModal);
            document.getElementById('cancelAddModal').addEventListener('click', closeAddVisitModal);
            document.getElementById('addVisitModal').addEventListener('click', function(e) {
                if (e.target === this) closeAddVisitModal();
            });
            
            // Модальное окно редактирования
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target === this) closeEditModal();
            });
        }

        function setupUI() {
            // Устанавливаем текущую дату и время для форм
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('visitDateTime').value = localDateTime;
            document.getElementById('modalVisitDateTime').value = localDateTime;
            
            // Заполняем фильтр пользователей
            const userFilter = document.getElementById('userFilter');
            appData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.username})`;
                userFilter.appendChild(option);
            });
        }

        // Авторизация
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                setCurrentUser(user);
                showAppScreen();
                loginError.classList.add('hidden');
                document.getElementById('loginForm').reset();
            } else {
                loginError.textContent = 'Неверный логин или пароль';
                loginError.classList.remove('hidden');
            }
        }

        function handleLogout() {
            setCurrentUser(null);
            showLoginScreen();
        }

        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
        }

        function showAppScreen() {
            loginScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
            
            updateUserInterface();
            switchTab('visits');
        }

        function updateUserInterface() {
            const user = getCurrentUser();
            const adminElements = document.querySelectorAll('.admin-only');
            const profileTab = document.getElementById('profileTab');
            
            // Показываем админские элементы только для админов
            adminElements.forEach(el => {
                if (user.role === 'admin') {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });
            
            // Обновляем профиль
            profileTab.textContent = user.name;
            updateUserInfo();
            
            // Обновляем список визитов
            displayVisits();
        }

        // Навигация
        function switchTab(tabName) {
            // Скрываем все вкладки
            tabContents.forEach(content => content.classList.add('hidden'));
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Показываем выбранную вкладку
            const activeTab = document.getElementById(tabName + 'Tab');
            const activeNavTab = document.querySelector(`[data-tab="${tabName}"]`);
            
            if (activeTab) activeTab.classList.remove('hidden');
            if (activeNavTab) activeNavTab.classList.add('active');
            
            // Обновляем содержимое при необходимости
            if (tabName === 'visits') {
                displayVisits();
            } else if (tabName === 'profile') {
                updateUserInfo();
            }
        }

        // Поиск врачей
        function setupDoctorSearch(inputId, dropdownId, hiddenInputId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            const hiddenInput = document.getElementById(hiddenInputId);
            
            let selectedDoctor = null;
            
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase();
                
                if (query.length < 2) {
                    dropdown.classList.add('hidden');
                    return;
                }
                
                const filteredDoctors = getDoctors().filter(doctor => 
                    doctor.name.toLowerCase().includes(query) || 
                    doctor.code.includes(query)
                );
                
                displayDoctorOptions(filteredDoctors, dropdown, input, hiddenInput);
            });
            
            input.addEventListener('blur', function() {
                // Задержка для обработки клика по опции
                setTimeout(() => {
                    dropdown.classList.add('hidden');
                }, 200);
            });
        }

        function displayDoctorOptions(doctors, dropdown, input, hiddenInput) {
            dropdown.innerHTML = '';
            
            if (doctors.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            doctors.slice(0, 10).forEach(doctor => {
                const option = document.createElement('div');
                option.className = 'doctor-option';
                option.innerHTML = `
                    <strong>${doctor.name}</strong>
                    <span class="doctor-code">#${doctor.code}</span>
                `;
                
                option.addEventListener('click', () => {
                    input.value = doctor.name;
                    hiddenInput.value = doctor.code;
                    dropdown.classList.add('hidden');
                });
                
                dropdown.appendChild(option);
            });
            
            dropdown.classList.remove('hidden');
        }

        // Управление визитами
        function handleAddVisit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const doctorCode = document.getElementById('selectedDoctorId').value;
            
            if (!doctorCode) {
                alert('Пожалуйста, выберите врача из списка');
                return;
            }
            
            const doctor = getDoctors().find(d => d.code === doctorCode);
            if (!doctor) {
                alert('Выбранный врач не найден');
                return;
            }
            
            const visit = {
                userId: getCurrentUser().id,
                userName: getCurrentUser().name,
                doctorCode: doctor.code,
                doctorName: doctor.name,
                visitDateTime: document.getElementById('visitDateTime').value,
                clinic: document.getElementById('clinic').value,
                amount: parseFloat(document.getElementById('amount').value),
                status: formData.get('status'),
                nextVisitDate: document.getElementById('nextVisitDate').value || null,
                comment: document.getElementById('comment').value
            };
            
            addVisit(visit);
            
            // Сброс формы и переключение на список визитов
            e.target.reset();
            document.getElementById('selectedDoctorId').value = '';
            switchTab('visits');
            
            alert('Визит успешно добавлен!');
        }

        function displayVisits() {
            const visitsList = document.getElementById('visitsList');
            const user = getCurrentUser();
            let visits = getVisits();
            
            // Фильтрация визитов по пользователю (если не админ)
            if (user.role !== 'admin') {
                visits = visits.filter(v => v.userId === user.id);
            }
            
            // Применение фильтров
            visits = applyFilters(visits);
            
            // Сортировка по дате (новые сначала)
            visits.sort((a, b) => new Date(b.visitDateTime) - new Date(a.visitDateTime));
            
            if (visits.length === 0) {
                visitsList.innerHTML = `
                    <div class="card">
                        <div class="card__body text-center">
                            <p style="color: var(--color-text-secondary);">Визиты не найдены</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            visitsList.innerHTML = visits.map(visit => {
                const visitDate = new Date(visit.visitDateTime);
                const statusBadge = visit.status === 'satisfied' 
                    ? '<span class="status status--success">✅ Доволен</span>'
                    : '<span class="status status--error">❌ Не доволен</span>';
                    
                const nextVisitText = visit.nextVisitDate 
                    ? new Date(visit.nextVisitDate).toLocaleDateString('ru-RU')
                    : 'Не указана';
                    
                return `
                    <div class="card">
                        <div class="visit-item">
                            <div class="visit-meta">
                                <div>
                                    <div class="visit-doctor">${visit.doctorName}</div>
                                    <div class="text-sm" style="color: var(--color-text-secondary);">Код: #${visit.doctorCode}</div>
                                    ${user.role === 'admin' ? `<div class="text-sm" style="color: var(--color-text-secondary);">Представитель: ${visit.userName}</div>` : ''}
                                </div>
                                <div>
                                    ${statusBadge}
                                </div>
                            </div>
                            
                            <div class="visit-details">
                                <div class="visit-detail">
                                    <strong>Дата визита:</strong>
                                    ${visitDate.toLocaleDateString('ru-RU')} в ${visitDate.toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
                                </div>
                                <div class="visit-detail">
                                    <strong>Клиника:</strong>
                                    ${visit.clinic}
                                </div>
                                <div class="visit-detail">
                                    <strong>Сумма:</strong>
                                    ${visit.amount} сом.
                                </div>
                                <div class="visit-detail">
                                    <strong>Следующий визит:</strong>
                                    ${nextVisitText}
                                </div>
                            </div>
                            
                            ${visit.comment ? `
                                <div class="visit-detail mt-8">
                                    <strong>Комментарий:</strong>
                                    ${visit.comment}
                                </div>
                            ` : ''}
                            
                            <div class="action-buttons">
                                ${canEditVisit(visit) ? `<button class="btn btn--sm btn--secondary" onclick="editVisit(${visit.id})">Редактировать</button>` : ''}
                                ${canDeleteVisit(visit) ? `<button class="btn btn--sm btn--danger" onclick="confirmDeleteVisit(${visit.id})">Удалить</button>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function canEditVisit(visit) {
            const user = getCurrentUser();
            return user.role === 'admin' || visit.userId === user.id;
        }

        function canDeleteVisit(visit) {
            const user = getCurrentUser();
            return user.role === 'admin' || visit.userId === user.id;
        }

        // Фильтрация
        function applyFilters(visits) {
            const dateFilter = document.getElementById('dateFilter').value;
            const userFilter = document.getElementById('userFilter').value;
            
            let filtered = visits;
            
            if (dateFilter) {
                const filterDate = new Date(dateFilter);
                filtered = filtered.filter(visit => {
                    const visitDate = new Date(visit.visitDateTime);
                    return visitDate.toDateString() === filterDate.toDateString();
                });
            }
            
            if (userFilter && getCurrentUser().role === 'admin') {
                filtered = filtered.filter(visit => visit.userId === userFilter);
            }
            
            return filtered;
        }

        function filterVisits() {
            displayVisits();
        }

        function clearFilters() {
            document.getElementById('dateFilter').value = '';
            document.getElementById('userFilter').value = '';
            displayVisits();
        }

        // Редактирование визитов
        let editingVisitId = null;

        function editVisit(visitId) {
            const visit = getVisits().find(v => v.id === visitId);
            if (!visit) return;
            
            editingVisitId = visitId;
            
            // Заполняем форму редактирования
            document.getElementById('editDoctorSearch').value = visit.doctorName;
            document.getElementById('editSelectedDoctorId').value = visit.doctorCode;
            document.getElementById('editVisitDateTime').value = visit.visitDateTime;
            document.getElementById('editClinic').value = visit.clinic;
            document.getElementById('editAmount').value = visit.amount;
            document.querySelector(`input[name="editStatus"][value="${visit.status}"]`).checked = true;
            document.getElementById('editNextVisitDate').value = visit.nextVisitDate || '';
            document.getElementById('editComment').value = visit.comment || '';
            
            // Показываем модальное окно
            document.getElementById('editModal').classList.remove('hidden');
        }

        function handleEditVisit(e) {
            e.preventDefault();
            
            if (!editingVisitId) return;
            
            const formData = new FormData(e.target);
            const doctorCode = document.getElementById('editSelectedDoctorId').value;
            
            if (!doctorCode) {
                alert('Пожалуйста, выберите врача из списка');
                return;
            }
            
            const doctor = getDoctors().find(d => d.code === doctorCode);
            if (!doctor) {
                alert('Выбранный врач не найден');
                return;
            }
            
            const updatedVisit = {
                doctorCode: doctor.code,
                doctorName: doctor.name,
                visitDateTime: document.getElementById('editVisitDateTime').value,
                clinic: document.getElementById('editClinic').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                status: formData.get('editStatus'),
                nextVisitDate: document.getElementById('editNextVisitDate').value || null,
                comment: document.getElementById('editComment').value
            };
            
            updateVisit(editingVisitId, updatedVisit);
            closeEditModal();
            displayVisits();
            
            alert('Визит успешно обновлен!');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingVisitId = null;
        }

        function confirmDeleteVisit(visitId) {
            if (confirm('Вы уверены, что хотите удалить этот визит?')) {
                deleteVisit(visitId);
                displayVisits();
                alert('Визит удален!');
            }
        }

        // Управление врачами
        function handleAddDoctor(e) {
            e.preventDefault();
            
            const name = document.getElementById('doctorName').value.trim();
            const code = document.getElementById('doctorCode').value.trim();
            
            // Проверка на существующий код
            const existingDoctor = getDoctors().find(d => d.code === code);
            if (existingDoctor) {
                alert('Врач с таким кодом уже существует!');
                return;
            }
            
            addDoctor({ code, name });
            
            e.target.reset();
            alert('Врач успешно добавлен!');
        }

        // Профиль пользователя
        function updateUserInfo() {
            const user = getCurrentUser();
            const userInfo = document.getElementById('userInfo');
            
            const visits = getVisits().filter(v => v.userId === user.id);
            const satisfiedVisits = visits.filter(v => v.status === 'satisfied').length;
            const totalAmount = visits.reduce((sum, v) => sum + v.amount, 0);
            
            userInfo.innerHTML = `
                <div class="visit-details">
                    <div class="visit-detail">
                        <strong>Имя:</strong>
                        ${user.name}
                    </div>
                    <div class="visit-detail">
                        <strong>Логин:</strong>
                        ${user.username}
                    </div>
                    <div class="visit-detail">
                        <strong>Роль:</strong>
                        ${user.role === 'admin' ? 'Администратор' : 'Торговый представитель'}
                    </div>
                    <div class="visit-detail">
                        <strong>Всего визитов:</strong>
                        ${visits.length}
                    </div>
                    <div class="visit-detail">
                        <strong>Довольных врачей:</strong>
                        ${satisfiedVisits} из ${visits.length}
                    </div>
                    <div class="visit-detail">
                        <strong>Общая сумма:</strong>
                        ${totalAmount.toFixed(2)} сом.
                    </div>
                </div>
            `;
        }

        // Модальное окно добавления визита
        function openAddVisitModal() {
            // Сбрасываем форму
            document.getElementById('addVisitModalForm').reset();
            document.getElementById('modalSelectedDoctorId').value = '';
            
            // Устанавливаем текущую дату и время
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('modalVisitDateTime').value = localDateTime;
            
            // Показываем модальное окно
            document.getElementById('addVisitModal').classList.remove('hidden');
        }

        function closeAddVisitModal() {
            document.getElementById('addVisitModal').classList.add('hidden');
        }

        function handleAddVisitFromModal(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const doctorCode = document.getElementById('modalSelectedDoctorId').value;
            
            if (!doctorCode) {
                alert('Пожалуйста, выберите врача из списка');
                return;
            }
            
            const doctor = getDoctors().find(d => d.code === doctorCode);
            if (!doctor) {
                alert('Выбранный врач не найден');
                return;
            }
            
            const visit = {
                userId: getCurrentUser().id,
                userName: getCurrentUser().name,
                doctorCode: doctor.code,
                doctorName: doctor.name,
                visitDateTime: document.getElementById('modalVisitDateTime').value,
                clinic: document.getElementById('modalClinic').value,
                amount: parseFloat(document.getElementById('modalAmount').value),
                status: formData.get('modalStatus'),
                nextVisitDate: document.getElementById('modalNextVisitDate').value || null,
                comment: document.getElementById('modalComment').value
            };
            
            addVisit(visit);
            closeAddVisitModal();
            displayVisits();
            
            alert('Визит успешно добавлен!');
        }

        // Глобальные функции для обработчиков событий
        window.editVisit = editVisit;
        window.confirmDeleteVisit = confirmDeleteVisit;
    </script>
</body>
</html>
